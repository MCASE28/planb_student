<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플랜비 지망생 현황판</title>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #3b82f6;
            --live: #ef4444;
            --calendar-cell: #334155;
            --calendar-active: #10b981; 
            --calendar-active-text: #ffffff;
        }

        body { font-family: 'Pretendard', 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        
        h1 { text-align: center; margin-bottom: 40px; font-weight: 800; color: var(--text-main); font-size: 2rem; }

        /* Grid Layout */
        #streamer-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* Card Style */
        .card { 
            display: flex; align-items: center; 
            background: var(--card-bg); border: 1px solid #334155; 
            padding: 20px; border-radius: 16px; 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-color: var(--accent); }
        .card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #475569; }
        
        .info h3 { margin: 0 0 5px 0; font-size: 1.1rem; display: flex; align-items: center; justify-content: space-between; }
        .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background-color: #475569; color: #cbd5e1; }
        .status-badge.live { background-color: var(--live); color: white; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { 
            background: var(--card-bg); margin: 3vh auto; padding: 30px; 
            width: 95%; max-width: 1300px; height: 90vh; 
            border-radius: 20px; position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
            overflow: hidden; 
        }
        .close { position: absolute; right: 25px; top: 20px; font-size: 30px; color: var(--text-sub); cursor: pointer; z-index: 10; }
        
        /* Modal Header */
        .modal-header { display: flex; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .modal-header > img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 2px solid #475569; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .soop-link { display: inline-flex; align-items: center; text-decoration: none; background: #334155; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; color: #fff; transition: background 0.2s; }
        .soop-link:hover { background: var(--accent); }
        .soop-icon { width: 16px !important; height: 16px !important; margin-right: 5px; border-radius: 4px; vertical-align: middle; }

        /* Modal Body Grid (Left: Calendar, Right: Graph) */
        .modal-body { display: flex; gap: 30px; height: 100%; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; }
        
        .right-panel { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            overflow-y: auto; 
            padding-right: 10px;
            justify-content: center; 
        }

        /* Legend Style */
        .calendar-legend {
            display: flex; gap: 15px; font-size: 1rem; color: var(--text-sub); 
            margin-bottom: 15px; background: #0f172a; padding: 10px 15px; border-radius: 12px;
            align-self: flex-start;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .box-vod { width: 15px; height: 15px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 3px; }
        .box-multi { width: 15px; height: 15px; background: rgba(16, 185, 129, 0.2); border: 1px solid #3b82f6; border-radius: 3px; }
        .box-empty { width: 15px; height: 15px; background: #334155; border-radius: 3px; }

        /* Calendar Styles */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-title { font-size: 1.2rem; font-weight: bold; }
        .btn-month { background: none; border: 1px solid #475569; color: var(--text-main); padding: 5px 10px; border-radius: 6px; cursor: pointer; }
        .btn-month:hover { background: #334155; }

        .calendar-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-header { color: var(--text-sub); font-size: 0.8rem; padding: 5px; }
        .cal-week-stat { font-size: 0.65rem; color: var(--text-sub); display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0f172a; border-radius: 8px; padding: 5px; line-height: 1.4; }
        .cal-day { 
            background: #334155; border-radius: 8px; min-height: 85px; padding: 5px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            position: relative; 
        }
        .cal-day.empty { background: transparent; }
        .cal-day.has-vod { background: rgba(16, 185, 129, 0.2); cursor: pointer; border: 1px solid rgba(16, 185, 129, 0.4); }
        .cal-day.has-vod:hover { background: rgba(16, 185, 129, 0.3); }
        .cal-day.multi-vod { border-color: #3b82f6; border-width: 1.5px; }
        
        .day-num { font-size: 0.9rem; margin-bottom: 5px; width: 100%; text-align: left; padding-left: 5px; font-weight: bold; }
        .day-time { font-size: 0.8rem; color: #6ee7b7; font-weight: bold; margin-top: auto; margin-bottom: auto; line-height: 1.2; }

        /* Graph Container */
        .chart-container { 
            background: #0f172a; padding: 20px; border-radius: 16px; 
            display: flex; flex-direction: column; margin-bottom: 20px; 
        }
        .chart-wrapper { position: relative; width: 100%; min-height: 270px; height: 270px; } 
        h3 { margin-top: 0; font-size: 1.1rem; color: var(--text-sub); margin-bottom: 20px; }

        footer { text-align: center; margin-top: 50px; color: var(--text-sub); font-size: 0.8rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        @media (max-width: 900px) {
            .modal-body { flex-direction: column; overflow-y: auto; }
            .modal-content { height: auto; max-height: 90vh; }
            .chart-wrapper { min-height: 200px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>플랜비 지망생 현황판</h1>
    
    <div id="streamer-list"></div>
    
    <footer>
        <p><strong>[안내]</strong></p>
        <p>본 서비스는 팬심으로 제작된 비공식 팬 사이트입니다.<br>
        SOOP(AfreecaTV)의 데이터를 실시간으로 조회하며, 방송인의 권리를 침해할 의도가 없습니다.<br>
        플랫폼 사정에 따라 데이터 조회가 일시적으로 제한될 수 있습니다.<br>
        만든이 : 옳다쿠나</p>
    </footer>
</div>

<!-- Modal -->
<div id="infoModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalHeader" class="modal-header"></div>
        <div class="modal-body">
            <!-- Left: Calendar -->
            <div class="left-panel">
                <div class="calendar-legend">
                    <div class="legend-item"><div class="box-vod"></div> 방송있음</div>
                    <div class="legend-item"><div class="box-multi"></div> 다시보기 2개이상</div>
                    <div class="legend-item"><div class="box-empty"></div> 없음</div>
                </div>
                <div class="calendar-controls">
                    <button class="btn-month" onclick="changeMonth(-1)">◀</button>
                    <div class="calendar-title" id="calTitle">2026. 1</div>
                    <button class="btn-month" onclick="changeMonth(1)">▶</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS Generated -->
                </div>
            </div>
            
            <!-- Right: Graph -->
            <div class="right-panel">
                <div class="chart-container">
                    <h3 id="chartTitle">월간 방송 시간 추이</h3>
                    <div class="chart-wrapper">
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        ids: ['likethis1125', 'gome02', 'moonightwmn', 'bluejin0129', 'uleharaaki']
    };

    const DEFAULT_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23334155'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='12' fill='%2394a3b8' dy='.3em' text-anchor='middle'%3ENo IMG%3C/text%3E%3C/svg%3E";
    const SOOP_ICON = "https://res.sooplive.co.kr/afreeca.ico"; 

    const MODAL = document.getElementById('infoModal');
    const STREAMER_DATA = {};
    
    let currentYear = 2026;
    let currentMonth = 1; 
    let currentStreamerId = null;
    let timeChartInstance = null;

    document.querySelector('.close').onclick = () => MODAL.style.display = "none";
    window.onclick = (e) => { if (e.target == MODAL) MODAL.style.display = "none"; }

    async function init() {
        const listContainer = document.getElementById('streamer-list');
        listContainer.innerHTML = '';

        CONFIG.ids.forEach(id => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${id}`;
            card.innerHTML = `<div class="loading" style="color:#94a3b8">Loading...</div>`;
            listContainer.appendChild(card);
        });

        const promises = CONFIG.ids.map(id => fetchStreamerData(id));
        await Promise.all(promises);
    }

    async function fetchStreamerData(id) {
        const card = document.getElementById(`card-${id}`);
        try {
            const response = await fetch(`/api/bj_info?id=${id}`);
            if (!response.ok) throw new Error('Net err');
            const data = await response.json();
            
            STREAMER_DATA[id] = data;

            const name = data.nickname || id;
            const img = data.profile_img || DEFAULT_IMG;
            const isLive = data.is_live;

            card.innerHTML = `
                <img src="${img}" alt="${id}" onerror="this.src='${DEFAULT_IMG}'">
                <div class="info">
                    <h3>${name} <span class="status-badge ${isLive ? 'live' : ''}">${isLive ? 'LIVE' : 'OFF'}</span></h3>
                    <p style="font-size:0.85rem; color:var(--text-sub);">@${id}</p>
                </div>
            `;
            
            card.onclick = () => openModal(id);

        } catch (err) {
            console.error(err);
            card.innerHTML = `<div class="info"><p style="color:var(--live)">Load Failed</p></div>`;
        }
    }

    function openModal(id) {
        const data = STREAMER_DATA[id];
        if (!data) return;

        currentStreamerId = id;
        currentYear = 2026; 
        currentMonth = 1; 

        updateModalHeader(data, currentYear, currentMonth);
        renderCalendar(); 
        MODAL.style.display = "block";
    }

    function updateModalHeader(data, year, month) {
        const header = document.getElementById('modalHeader');
        const img = data.profile_img || DEFAULT_IMG;
        
        let totalDurationSec = 0;
        let count = 0;
        const monthPrefix = `${year}-${String(month).padStart(2,'0')}`;
        
        data.vods.forEach(v => {
            if (v.date.startsWith(monthPrefix)) {
                totalDurationSec += v.duration_sec || 0;
                count++;
            }
        });
        
        let avgTimeStr = "0분";
        if (count > 0) {
            const avgSec = totalDurationSec / count;
            const h = Math.floor(avgSec / 3600);
            const m = Math.floor((avgSec % 3600) / 60);
            avgTimeStr = h > 0 ? `${h}시간 ${m}분` : `${m}분`;
        }

        header.innerHTML = `
            <img src="${img}">
            <div>
                <h2>${data.nickname} 
                    <a href="https://www.sooplive.co.kr/station/${data.id}" target="_blank" class="soop-link">
                        <img src="${SOOP_ICON}" class="soop-icon" onerror="this.style.display='none'"> 방송국
                    </a>
                </h2>
                <p style="color:var(--text-sub); margin:5px 0 0 0">
                    애청자 ${data.fan_cnt.toLocaleString()}명 · ${month}월 평균 방송시간 <b style="color:#fff">${avgTimeStr}</b>
                </p>
            </div>
        `;
    }

    function changeMonth(delta) {
        let newDate = new Date(currentYear, currentMonth - 1 + delta, 1);
        let newYear = newDate.getFullYear();
        let newMonth = newDate.getMonth() + 1;

        if (newYear < 2025 || (newYear === 2025 && newMonth < 10)) return;
        if (newYear > 2026 || (newYear === 2026 && newMonth > 2)) return;

        currentYear = newYear;
        currentMonth = newMonth;
        
        if (currentStreamerId && STREAMER_DATA[currentStreamerId]) {
            updateModalHeader(STREAMER_DATA[currentStreamerId], currentYear, currentMonth);
        }

        renderCalendar();
    }

    function renderCalendar() {
        const title = document.getElementById('calTitle');
        const grid = document.getElementById('calendarGrid');
        const chartTitle = document.getElementById('chartTitle');
        
        title.innerText = `${currentYear}. ${currentMonth}`;
        chartTitle.innerText = `${currentYear}년 ${currentMonth}월 방송 시간`;

        grid.innerHTML = '';

        const days = ['주간', '일', '월', '화', '수', '목', '금', '토'];
        days.forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

        const firstDay = new Date(currentYear, currentMonth - 1, 1);
        const lastDay = new Date(currentYear, currentMonth, 0);
        
        const startDay = firstDay.getDay(); 
        const totalDays = lastDay.getDate();

        const data = STREAMER_DATA[currentStreamerId];
        const vodMap = {}; 
        
        if(data && data.vods) {
            data.vods.forEach(v => {
                if (!vodMap[v.date]) vodMap[v.date] = [];
                vodMap[v.date].push(v);
            });
        }

        let currentWeekStats = { count: 0, totalSec: 0 };

        for (let i = 0; i < startDay; i++) {
            if (i === 0) grid.innerHTML += `<div class="cal-week-stat"></div>`;
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        for (let d = 1; d <= totalDays; d++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const vods = vodMap[dateStr];
            
            if ((startDay + d - 1) % 7 === 0) {
                grid.innerHTML += `<div class="cal-week-stat"></div>`;
                currentWeekStats = { count: 0, totalSec: 0 };
            }

            let content = `<div class="day-num">${d}</div>`;
            let className = "cal-day";
            let onClick = "";

            if (vods && vods.length > 0) {
                className += " has-vod";
                if (vods.length > 1) className += " multi-vod";

                let totalSec = 0;
                let timeHtml = ""; 

                vods.forEach((v, index) => {
                    totalSec += (v.duration_sec || 0);
                    const parts = v.duration.split(':').map(Number);
                    let tStr = "";
                    if(parts.length===3 && parts[0]>0) tStr = `${parts[0]}시간`;
                    else if(parts.length===2) tStr = `${parts[0]}분`;
                    else tStr = v.duration;
                    timeHtml += `<div>${tStr}</div>`;
                });

                const mainVod = vods[0]; 
                currentWeekStats.count += vods.length;
                currentWeekStats.totalSec += totalSec;
                updateWeekStat(currentWeekStats);

                content += `<div class="day-time">${timeHtml}</div>`;
                onClick = `onclick="window.open('${mainVod.link}', '_blank')"`;
            }

            grid.innerHTML += `<div class="${className}" ${onClick}>${content}</div>`;
        }

        renderCharts(data.vods);
    }

    function updateWeekStat(stats) {
        const statsDivs = document.getElementsByClassName('cal-week-stat');
        if (statsDivs.length > 0) {
            const lastStat = statsDivs[statsDivs.length - 1];
            const avg = stats.count > 0 ? (stats.totalSec / 3600 / stats.count).toFixed(1) : 0.0;
            lastStat.innerHTML = `<span>${stats.count}회</span><span style="color:#6ee7b7">평균 ${avg}h</span>`;
        }
    }

    function renderCharts(vods) {
        const labels = [];
        const durationData = [];
        const lastDayObj = new Date(currentYear, currentMonth, 0);
        const totalDays = lastDayObj.getDate();
        
        for (let d = 1; d <= totalDays; d++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            labels.push(String(d)); 
            let dayDuration = 0;
            if (vods) {
                vods.forEach(v => {
                    if (v.date === dateStr) dayDuration += (v.duration_sec || 0) / 3600; 
                });
            }
            durationData.push(dayDuration);
        }

        if (timeChartInstance) timeChartInstance.destroy();

        const ctx1 = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '방송 시간',
                    data: durationData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    tension: 0.4,  /* 0.1에서 0.4로 변경하여 곡선형으로 만듦 */
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + '시간'; 
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#334155';

    init();
</script>
</body>
</html>