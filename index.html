<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOOP Streamer Status</title>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #3b82f6;
            --live: #ef4444;
            --calendar-cell: #334155;
            --calendar-active: #10b981; 
            --calendar-active-text: #ffffff;
        }

        body { font-family: 'Pretendard', 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        
        h1 { text-align: center; margin-bottom: 40px; font-weight: 800; color: var(--text-main); font-size: 2rem; }

        /* Grid Layout */
        #streamer-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        /* Card Style */
        .card { 
            display: flex; align-items: center; 
            background: var(--card-bg); border: 1px solid #334155; 
            padding: 20px; border-radius: 16px; 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-color: var(--accent); }
        .card img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid #475569; }
        
        .info h3 { margin: 0 0 5px 0; font-size: 1.1rem; display: flex; align-items: center; justify-content: space-between; }
        .status-badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background-color: #475569; color: #cbd5e1; }
        .status-badge.live { background-color: var(--live); color: white; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        .modal-content { 
            background: var(--card-bg); margin: 3vh auto; padding: 30px; 
            width: 95%; max-width: 1200px; height: 90vh; 
            border-radius: 20px; position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); 
            overflow: hidden; /* 내부 스크롤 사용 */
        }
        .close { position: absolute; right: 25px; top: 20px; font-size: 30px; color: var(--text-sub); cursor: pointer; z-index: 10; }
        
        /* Modal Header - CSS Fix Applied Here */
        .modal-header { display: flex; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .modal-header > img { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 2px solid #475569; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .soop-link { display: inline-flex; align-items: center; text-decoration: none; background: #334155; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; color: #fff; transition: background 0.2s; }
        .soop-link:hover { background: var(--accent); }
        .soop-icon { width: 16px !important; height: 16px !important; margin-right: 5px; border-radius: 4px; vertical-align: middle; }

        /* Modal Body Grid (Left: Calendar, Right: Graphs) */
        .modal-body { display: flex; gap: 30px; height: 100%; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 10px; }
        .right-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-right: 10px; }

        /* Calendar Styles */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-title { font-size: 1.2rem; font-weight: bold; }
        .btn-month { background: none; border: 1px solid #475569; color: var(--text-main); padding: 5px 10px; border-radius: 6px; cursor: pointer; }
        .btn-month:hover { background: #334155; }

        .calendar-grid { display: grid; grid-template-columns: 50px repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-header { color: var(--text-sub); font-size: 0.8rem; padding: 5px; }
        .cal-week-stat { font-size: 0.7rem; color: var(--text-sub); display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0f172a; border-radius: 8px; padding: 5px; }
        .cal-day { 
            background: #334155; border-radius: 8px; min-height: 80px; padding: 5px; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            position: relative; 
        }
        .cal-day.empty { background: transparent; }
        .cal-day.has-vod { background: rgba(16, 185, 129, 0.2); cursor: pointer; border: 1px solid rgba(16, 185, 129, 0.4); }
        .cal-day.has-vod:hover { background: rgba(16, 185, 129, 0.3); }
        
        .day-num { font-size: 0.9rem; margin-bottom: 5px; width: 100%; text-align: left; padding-left: 5px; font-weight: bold; }
        .day-time { font-size: 0.8rem; color: #6ee7b7; font-weight: bold; margin-top: auto; margin-bottom: auto; }

        /* Graph Container */
        .chart-container { background: #0f172a; padding: 15px; border-radius: 16px; flex: 1; min-height: 250px; }
        h3 { margin-top: 0; font-size: 1rem; color: var(--text-sub); margin-bottom: 10px; }

        footer { text-align: center; margin-top: 50px; color: var(--text-sub); font-size: 0.8rem; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        @media (max-width: 900px) {
            .modal-body { flex-direction: column; overflow-y: auto; }
            .modal-content { height: auto; max-height: 90vh; }
            .chart-container { min-height: 200px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SOOP Streamer Status</h1>
    
    <div id="streamer-list"></div>
    
    <footer>
        <p><strong>[안내]</strong></p>
        <p>본 서비스는 팬심으로 제작된 비공식 팬 사이트입니다.<br>
        SOOP(AfreecaTV)의 데이터를 실시간으로 조회하며, 방송인의 권리를 침해할 의도가 없습니다.<br>
        플랫폼 사정에 따라 데이터 조회가 일시적으로 제한될 수 있습니다.</p>
    </footer>
</div>

<!-- Modal -->
<div id="infoModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalHeader" class="modal-header"></div>
        <div class="modal-body">
            <!-- Left: Calendar -->
            <div class="left-panel">
                <div class="calendar-controls">
                    <button class="btn-month" onclick="changeMonth(-1)">◀</button>
                    <div class="calendar-title" id="calTitle">2026. 1</div>
                    <button class="btn-month" onclick="changeMonth(1)">▶</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS Generated -->
                </div>
            </div>
            
            <!-- Right: Graphs -->
            <div class="right-panel">
                <div class="chart-container">
                    <h3>2026년 1월 1일 ~ 현재 방송 시간</h3>
                    <canvas id="timeChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>2026년 1월 1일 ~ 현재 애청자 수</h3>
                    <canvas id="viewChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = {
        ids: ['likethis1125', 'gome02', 'moonightwmn', 'bluejin0129', 'uleharaaki', 'beemong'] 
    };

    const DEFAULT_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23334155'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='12' fill='%2394a3b8' dy='.3em' text-anchor='middle'%3ENo IMG%3C/text%3E%3C/svg%3E";
    const SOOP_ICON = "https://res.sooplive.co.kr/afreeca.ico"; // SOOP 공식 파비콘

    const MODAL = document.getElementById('infoModal');
    const STREAMER_DATA = {};
    
    // 캘린더 상태 (2026년 기준)
    let currentYear = 2026;
    let currentMonth = 1; 
    let currentStreamerId = null;

    // 차트 인스턴스
    let timeChartInstance = null;
    let viewChartInstance = null;

    document.querySelector('.close').onclick = () => MODAL.style.display = "none";
    window.onclick = (e) => { if (e.target == MODAL) MODAL.style.display = "none"; }

    async function init() {
        const listContainer = document.getElementById('streamer-list');
        listContainer.innerHTML = '';

        CONFIG.ids.forEach(id => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${id}`;
            card.innerHTML = `<div class="loading" style="color:#94a3b8">Loading...</div>`;
            listContainer.appendChild(card);
        });

        const promises = CONFIG.ids.map(id => fetchStreamerData(id));
        await Promise.all(promises);
    }

    async function fetchStreamerData(id) {
        const card = document.getElementById(`card-${id}`);
        try {
            const response = await fetch(`/api/bj_info?id=${id}`);
            if (!response.ok) throw new Error('Net err');
            const data = await response.json();
            
            STREAMER_DATA[id] = data;

            const name = data.nickname || id;
            const img = data.profile_img || DEFAULT_IMG;
            const isLive = data.is_live;

            card.innerHTML = `
                <img src="${img}" alt="${id}" onerror="this.src='${DEFAULT_IMG}'">
                <div class="info">
                    <h3>${name} <span class="status-badge ${isLive ? 'live' : ''}">${isLive ? 'LIVE' : 'OFF'}</span></h3>
                    <p style="font-size:0.85rem; color:var(--text-sub);">@${id}</p>
                </div>
            `;
            
            card.onclick = () => openModal(id);

        } catch (err) {
            console.error(err);
            card.innerHTML = `<div class="info"><p style="color:var(--live)">Load Failed</p></div>`;
        }
    }

    function openModal(id) {
        const data = STREAMER_DATA[id];
        if (!data) return;

        currentStreamerId = id;
        currentYear = 2026; 
        currentMonth = 1; 

        // 1달(이번달 기준) 평균 방송 시간 계산
        let totalDurationSec = 0;
        let count = 0;
        const now = new Date(); // 2026-01-XX
        const thisMonthPrefix = `2026-${String(now.getMonth()+1).padStart(2,'0')}`;
        
        data.vods.forEach(v => {
            if (v.date.startsWith(thisMonthPrefix)) {
                totalDurationSec += v.duration_sec || 0;
                count++;
            }
        });
        
        // 방송 1회당 평균 시간
        let avgTimeStr = "0분";
        if (count > 0) {
            const avgSec = totalDurationSec / count;
            const h = Math.floor(avgSec / 3600);
            const m = Math.floor((avgSec % 3600) / 60);
            avgTimeStr = h > 0 ? `${h}시간 ${m}분` : `${m}분`;
        }

        // Header
        const header = document.getElementById('modalHeader');
        const img = data.profile_img || DEFAULT_IMG;
        header.innerHTML = `
            <img src="${img}">
            <div>
                <h2>${data.nickname} 
                    <a href="https://www.sooplive.co.kr/station/${id}" target="_blank" class="soop-link">
                        <img src="${SOOP_ICON}" class="soop-icon" onerror="this.style.display='none'"> 방송국
                    </a>
                </h2>
                <p style="color:var(--text-sub); margin:5px 0 0 0">
                    애청자 ${data.fan_cnt.toLocaleString()}명 · 1달 평균 방송시간 ${avgTimeStr}
                </p>
            </div>
        `;

        renderCalendar();
        renderCharts(data.vods, data.fan_cnt);
        
        MODAL.style.display = "block";
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 1) currentMonth = 1;
        if (currentMonth > 2) currentMonth = 2;
        renderCalendar();
    }

    function renderCalendar() {
        const title = document.getElementById('calTitle');
        const grid = document.getElementById('calendarGrid');
        
        title.innerText = `${currentYear}. ${currentMonth}`;
        grid.innerHTML = '';

        const days = ['주간', '일', '월', '화', '수', '목', '금', '토'];
        days.forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

        const firstDay = new Date(currentYear, currentMonth - 1, 1);
        const lastDay = new Date(currentYear, currentMonth, 0);
        
        const startDay = firstDay.getDay(); 
        const totalDays = lastDay.getDate();

        const data = STREAMER_DATA[currentStreamerId];
        const vodMap = {}; 
        
        if(data && data.vods) {
            data.vods.forEach(v => {
                if (!vodMap[v.date]) vodMap[v.date] = [];
                vodMap[v.date].push(v);
            });
        }

        let currentWeekStats = { count: 0, totalSec: 0 };

        for (let i = 0; i < startDay; i++) {
            if (i === 0) grid.innerHTML += `<div class="cal-week-stat"></div>`;
            grid.innerHTML += `<div class="cal-day empty"></div>`;
        }

        for (let d = 1; d <= totalDays; d++) {
            const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const vods = vodMap[dateStr];
            
            if ((startDay + d - 1) % 7 === 0) {
                grid.innerHTML += `<div class="cal-week-stat" id="week-stat-${d}"></div>`;
                currentWeekStats = { count: 0, totalSec: 0 };
            }

            let content = `<div class="day-num">${d}</div>`;
            let className = "cal-day";
            let onClick = "";

            if (vods && vods.length > 0) {
                className += " has-vod";
                const mainVod = vods[0]; 
                
                const parts = mainVod.duration.split(':').map(Number);
                let timeText = "";
                let sec = mainVod.duration_sec || 0;

                currentWeekStats.count += vods.length;
                currentWeekStats.totalSec += sec;
                
                updateWeekStat(d, startDay, currentWeekStats);

                if (parts.length === 3 && parts[0] > 0) timeText = `${parts[0]}시간`;
                else if (parts.length === 2) timeText = `${parts[0]}분`;
                else timeText = mainVod.duration; 
                
                content += `<div class="day-time">${timeText}</div>`;
                onClick = `onclick="window.open('${mainVod.link}', '_blank')"`;
            }

            grid.innerHTML += `<div class="${className}" ${onClick}>${content}</div>`;
        }
    }

    function updateWeekStat(currentDate, startDay, stats) {
        const statsDivs = document.getElementsByClassName('cal-week-stat');
        if (statsDivs.length > 0) {
            const lastStat = statsDivs[statsDivs.length - 1];
            const avg = stats.count > 0 ? (stats.totalSec / 3600 / stats.count).toFixed(1) : 0.0;
            lastStat.innerHTML = `<span>${stats.count}회</span><span style="color:#6ee7b7">${avg}h</span>`;
        }
    }

    function renderCharts(vods, currentFanCnt) {
        // 기준일: 2026-01-01 ~ 오늘 (2026-01-03)
        const labels = [];
        const durationData = [];
        const fanData = [];

        const start = new Date('2026-01-01');
        const end = new Date(); // 2026-01-03
        
        // 날짜 순회
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            labels.push(dateStr.slice(5)); // "01-01"
            
            // 방송 시간 집계
            let dayDuration = 0;
            if (vods) {
                vods.forEach(v => {
                    if (v.date === dateStr) {
                        dayDuration += (v.duration_sec || 0) / 3600; 
                    }
                });
            }
            durationData.push(dayDuration);
            
            // 애청자 수 (변동 없음)
            fanData.push(currentFanCnt);
        }

        // 차트 파괴
        if (timeChartInstance) timeChartInstance.destroy();
        if (viewChartInstance) viewChartInstance.destroy();

        // 1. 방송 시간 차트
        const ctx1 = document.getElementById('timeChart').getContext('2d');
        timeChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '방송 시간',
                    data: durationData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + '시간'; 
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#334155' } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 2. 애청자 수 차트
        const ctx2 = document.getElementById('viewChart').getContext('2d');
        viewChartInstance = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '애청자 수',
                    data: fanData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    tension: 0,
                    fill: false,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: false, 
                        grid: { color: '#334155' } 
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.borderColor = '#334155';

    init();
</script>
</body>
</html>