<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”Œëœë¹„ ì§€ë§ìƒ í˜„í™©íŒ</title>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --accent: #3b82f6;
            --live: #ef4444;
            --calendar-cell: #334155;
            --calendar-active: #10b981;
            --calendar-active-text: #ffffff;
        }

        body {
            font-family: 'Pretendard', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-weight: 800;
            color: var(--text-main);
            font-size: 2rem;
        }

        /* Grid Layout */
        #streamer-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        /* Card Style */
        .card {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid #334155;
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-color: var(--accent);
        }

        .card.novice {
            border-color: #86efac;
            border-width: 1px;
        }

        .card img {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #475569;
        }

        .info {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 2px;
            overflow: hidden;
        }

        .info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2px;
            gap: 5px;
        }

        .info-header h3 {
            margin: 0;
            font-size: 1.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .info-id {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .info-fan {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .post-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-main);
            text-decoration: none;
            background: #334155;
            padding: 5px 10px;
            border-radius: 8px;
            width: fit-content;
            transition: background 0.2s;
        }

        .post-link:hover {
            background: var(--accent);
        }

        .post-link img {
            width: 14px !important;
            height: 14px !important;
            border: none !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: #475569;
            color: #cbd5e1;
        }

        .status-badge.live {
            background-color: var(--live);
            color: white;
            animation: pulse 2s infinite;
        }

        .novice-badge {
            font-size: 0.75rem;
            margin-right: 5px;
            color: #86efac;
            font-weight: bold;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 3vh auto;
            padding: 30px;
            width: 95%;
            max-width: 1300px;
            height: 90vh;
            border-radius: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .close {
            position: absolute;
            right: 25px;
            top: 20px;
            font-size: 30px;
            color: var(--text-sub);
            cursor: pointer;
            z-index: 10;
        }

        /* Modal Header */
        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .modal-header>img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid #475569;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .soop-link {
            display: inline-flex;
            align-items: center;
            text-decoration: none;
            background: #334155;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #fff;
            transition: background 0.2s;
        }

        .soop-link:hover {
            background: var(--accent);
        }

        .soop-icon {
            width: 16px !important;
            height: 16px !important;
            margin-right: 5px;
            border-radius: 4px;
            vertical-align: middle;
        }

        /* Modal Body Grid (Left: Calendar, Right: Graph) */
        .modal-body {
            display: flex;
            gap: 30px;
            height: 100%;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding-right: 10px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 10px;
            justify-content: center;
        }

        /* Legend Style */
        .calendar-legend {
            display: flex;
            gap: 15px;
            font-size: 1rem;
            color: var(--text-sub);
            margin-bottom: 15px;
            background: #0f172a;
            padding: 10px 15px;
            border-radius: 12px;
            align-self: flex-start;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .box-vod {
            width: 15px;
            height: 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 3px;
        }

        .box-multi {
            width: 15px;
            height: 15px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 3px;
        }

        .box-empty {
            width: 15px;
            height: 15px;
            background: #334155;
            border-radius: 3px;
        }

        /* Calendar Styles */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .btn-month {
            background: none;
            border: 1px solid #475569;
            color: var(--text-main);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-month:hover {
            background: #334155;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .cal-header {
            color: var(--text-sub);
            font-size: 0.8rem;
            padding: 5px;
        }

        .cal-week-stat {
            font-size: 0.65rem;
            color: var(--text-sub);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #0f172a;
            border-radius: 8px;
            padding: 5px;
            line-height: 1.4;
        }

        .cal-day {
            background: #334155;
            border-radius: 8px;
            min-height: 85px;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
        }

        .cal-day.empty {
            background: transparent;
        }

        .cal-day.has-vod {
            background: rgba(16, 185, 129, 0.2);
            cursor: pointer;
            border: 1px solid rgba(16, 185, 129, 0.4);
        }

        .cal-day.has-vod:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .cal-day.multi-vod {
            border-color: #3b82f6;
            border-width: 1.5px;
        }

        .cal-day.is-today {
            border: 2px solid var(--live) !important;
        }

        /* ì˜¤ëŠ˜ ë‚ ì§œ ë¶‰ì€ í…Œë‘ë¦¬ */
        .cal-day.station-open-day {
            border-top: 4px solid #facc15 !important;
            border-left: 4px solid #facc15 !important;
        }

        /* ë°©ì†¡êµ­ ê°œì„¤ì¼ */

        .day-num {
            font-size: 0.9rem;
            margin-bottom: 5px;
            width: 100%;
            text-align: left;
            padding-left: 5px;
            font-weight: bold;
        }

        .day-time {
            font-size: 0.8rem;
            color: #6ee7b7;
            font-weight: bold;
            margin-top: auto;
            margin-bottom: auto;
            line-height: 1.2;
        }

        /* Graph Container */
        .chart-container {
            background: #0f172a;
            padding: 20px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            min-height: 270px;
            height: 270px;
        }

        h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: var(--text-sub);
            margin-bottom: 20px;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--text-sub);
            font-size: 0.8rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        @media (max-width: 900px) {
            .modal-body {
                flex-direction: column;
                overflow-y: auto;
            }

            .modal-content {
                height: auto;
                max-height: 90vh;
            }

            .chart-wrapper {
                min-height: 200px;
            }
        }

        /* Cafe Link Style */
        .cafe-link-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .cafe-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-main);
            font-size: 15pt;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .cafe-link:hover {
            opacity: 0.8;
        }

        .cafe-link img {
            width: 15px;
            height: 15px;
            border-radius: 6px;
        }

        /* Social Links in Card */
        .social-links {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .social-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #334155;
            border: 1px solid #475569;
            transition: all 0.2s;
            text-decoration: none;
        }

        .social-btn:hover {
            background: #475569;
            transform: scale(1.1);
            border-color: var(--text-sub);
        }

        .social-btn img {
            width: 16px;
            height: 16px;
            border-radius: 0 !important;
            border: none !important;
            margin: 0 !important;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 41, 59, 0.7);
            /* card-bg with opacity */
            backdrop-filter: blur(5px);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #334155;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-main);
            font-weight: bold;
        }

        .team-logo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            object-fit: contain;
            background-color: white;
            border-radius: 15px;
            padding: 10px;
            box-sizing: border-box;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        @media (max-width: 768px) {
            .team-logo {
                width: 80px;
                height: 80px;
                top: 10px;
                right: 10px;
                border-radius: 12px;
                padding: 5px;
            }
        }
    </style>
</head>

<body>
    <img src="team_logo.png" class="team-logo" alt="Team Logo">



    <div class="container">
        <h1>í”Œëœë¹„ ì§€ë§ìƒ í˜„í™©íŒ(26.01.29 AM 12:00 ê¸°ì¤€)</h1>

        <div class="cafe-link-container">
            <a href="https://cafe.naver.com/f-e/cafes/30723072/menus/270" target="_blank" class="cafe-link">
                <img src="https://cafe.naver.com/favicon.ico" alt="Naver Cafe">
                ê²Œì‹œíŒ ì´ë™í•˜ê¸°
            </a>
            <span style="color: var(--text-sub); margin: 0 10px;">/</span>
            <a href="#" onclick="location.reload(); return false;" class="cafe-link">
                ìƒˆë¡œê³ ì¹¨
            </a>
        </div>

        <div id="streamer-list"></div>

        <footer>
            <p><strong>[ì•ˆë‚´]</strong></p>
            <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” íŒ¬ì‹¬ìœ¼ë¡œ ì œì‘ëœ ë¹„ê³µì‹ íŒ¬ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.<br>
                SOOPì˜ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ë©°, ë°©ì†¡ì¸ì˜ ê¶Œë¦¬ë¥¼ ì¹¨í•´í•  ì˜ë„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                í”Œë«í¼ ì‚¬ì •ì— ë”°ë¼ ë°ì´í„° ì¡°íšŒê°€ ì¼ì‹œì ìœ¼ë¡œ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                ë§Œë“ ì´ : ì˜³ë‹¤ì¿ ë‚˜</p>
        </footer>
    </div>

    <!-- Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div>
                <div class="loading-text">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <span class="close">&times;</span>
            <div id="modalHeader" class="modal-header"></div>
            <div class="modal-body">
                <!-- Left: Calendar -->
                <div class="left-panel">
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="box-vod"></div> ë°©ì†¡ìˆìŒ
                        </div>
                        <div class="legend-item">
                            <div class="box-multi"></div> ë‹¤ì‹œë³´ê¸° 2ê°œì´ìƒ
                        </div>
                        <div class="legend-item">
                            <div class="box-empty"></div> ì—†ìŒ
                        </div>
                    </div>
                    <div class="calendar-controls">
                        <button class="btn-month" onclick="changeMonth(-1)">â—€</button>
                        <div class="calendar-title" id="calTitle">2026. 1</div>
                        <button class="btn-month" onclick="changeMonth(1)">â–¶</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- JS Generated -->
                    </div>
                </div>

                <!-- Right: Graph -->
                <div class="right-panel">
                    <div class="chart-container">
                        <h3 id="chartTitle">ì›”ê°„ ë°©ì†¡ ì‹œê°„ ì¶”ì´</h3>

                        <div class="chart-wrapper">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            ids: [
                'bluejin0129,178387', // ì§€ì˜¤
                'gome02,178469', // ë°¤ë¬¸
                'likethis1125,178530', // ë„í˜
                'whitesora,178972', //ë°±ì†Œë¼
                'zzeogoo,179313', // í–„ì©Œêµ¬
                'reaper7862,180188', //rp7
                'dlsvhwk00,180222', // ì‹´ë ¨
                'seri1100,181092', // ëª½ì„¸ë¦¬
                'whtndus0830,181159', // ìª¼ì•„ë‚˜
                'marihema,182596', //ë§ˆë¦¬íˆ
                'somnnya,182631', //ê¹€ì†œëƒ
                'runna11,184323', //ë£¬ë‚˜
                'ninfantaem,184359', //ë‹¬ë‹¬í–‡
                'haruniong,186110', //í•˜ë£¨ë‡½
                'moonngnung,187390', //ëª¨ì„œë¦¬
                'r1s1n9star,187448', //ìƒ›ë²¼ë¦¬
                'yonakayo05,188017', //ìš”ë‚˜ì¹´
                'ykh125,189669', //ì„¸ë¡œ
                'sayseram2,190266' //ìœ¤ì„¸ëŒ
            ]
        };

        const DEFAULT_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23334155'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='12' fill='%2394a3b8' dy='.3em' text-anchor='middle'%3ENo IMG%3C/text%3E%3C/svg%3E";
        const SOOP_ICON = "https://res.sooplive.co.kr/afreeca.ico";

        const MODAL = document.getElementById('infoModal');
        const LOADING_OVERLAY = document.getElementById('loadingOverlay');
        const STREAMER_DATA = {};
        const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„ ìºì‹œ

        let currentYear = 2026;
        let currentMonth = 1;
        let currentStreamerId = null;
        let timeChartInstance = null;

        document.querySelector('.close').onclick = () => MODAL.style.display = "none";
        window.onclick = (e) => { if (e.target == MODAL) MODAL.style.display = "none"; }

        // ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        function startApp() {
            init();
        }



        async function init() {
            const listContainer = document.getElementById('streamer-list');
            listContainer.innerHTML = '';

            console.log('Loaded Configuration:', CONFIG.ids);

            CONFIG.ids.forEach(entry => {
                const [id, postId] = entry.split(',').map(s => s.trim()); // ê³µë°± ì œê±° ì¶”ê°€
                // ì´ˆê¸° ë°ì´í„°ì— ê²Œì‹œê¸€ ë²ˆí˜¸ ì €ì¥
                STREAMER_DATA[id] = { postId: postId || '0' };

                const card = document.createElement('div');
                card.className = 'card';
                card.id = `card-${id}`;
                card.innerHTML = `<div class="loading" style="color:#94a3b8; font-size:0.9rem">ë°ì´í„° ìš”ì²­ ì¤‘...</div>`;
                listContainer.appendChild(card);
            });

            // ì´ˆê¸° ë¡œë”©ì€ 'basic' ëª¨ë“œë¡œ ê°€ë³ê²Œ ìš”ì²­
            const promises = CONFIG.ids.map(entry => {
                const [id] = entry.split(',');
                return fetchStreamerData(id, 'basic');
            });
            await Promise.all(promises);
        }

        async function fetchStreamerData(id, mode = 'basic') {
            const card = document.getElementById(`card-${id}`);
            let timer = null;

            // Basic ëª¨ë“œì¼ ë•Œë§Œ ì¹´ë“œ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ (ì´ˆê¸° ì§„ì… ì‹œ)
            if (mode === 'basic' && card) {
                const loadingDiv = card.querySelector('.loading');
                const msgs = ["ì—°ê²° ì¤‘...", "ì •ë³´ í™•ì¸...", "ìƒíƒœ ì²´í¬..."];
                let step = 0;
                timer = setInterval(() => {
                    if (loadingDiv) {
                        step++;
                        loadingDiv.innerText = msgs[step % msgs.length];
                    }
                }, 300);
            }

            try {
                // mode íŒŒë¼ë¯¸í„° ì¶”ê°€
                const fetchReq = fetch(`/api/bj_info?id=${id}&mode=${mode}`);

                // Basic ëª¨ë“œì¼ ë•Œ ìµœì†Œ ë¡œë”© ì‹œê°„ ë³´ì¥ (UX)
                if (mode === 'basic') {
                    await new Promise(r => setTimeout(r, 500));
                }

                const response = await fetchReq;
                if (timer) clearInterval(timer);

                // ì‘ë‹µ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ë¨¼ì € í™•ì¸
                const text = await response.text();



                if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                if (!text) throw new Error('Empty Response');

                let newData;
                try {
                    newData = JSON.parse(text);
                } catch (e) {
                    console.error('JSON Parse Error:', text);
                    throw new Error('Invalid JSON');
                }



                // ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë©´ì„œ ìµœì‹  ë°ì´í„°ë¡œ ë®ì–´ì“°ê¸°)
                STREAMER_DATA[id] = {
                    ...(STREAMER_DATA[id] || {}),
                    ...newData,
                    lastUpdated: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹ 
                };

                // Basic ì •ë³´ê°€ ì˜¤ë©´ ì¹´ë“œ UI ê°±ì‹  (Full ìš”ì²­ ì‹œì—ë„ ìµœì‹  ê¸°ë³¸ì •ë³´ê°€ ì˜¤ë¯€ë¡œ ê°±ì‹ )
                updateCardUI(id);

            } catch (err) {
                if (timer) clearInterval(timer);
                console.error(err);
                if (mode === 'basic' && card) {
                    card.innerHTML = `<div class="info"><p style="color:var(--live)">Load Failed</p></div>`;
                }
            }
        }

        function updateCardUI(id) {
            const data = STREAMER_DATA[id];
            const card = document.getElementById(`card-${id}`);
            if (!data || !card) return;

            const name = data.nickname || id;
            const img = data.profile_img || DEFAULT_IMG;
            const isLive = data.is_live;
            const fanCnt = data.fan_cnt || 0;
            const isNovice = fanCnt < 300;

            if (isNovice) card.classList.add('novice');
            else card.classList.remove('novice');

            // ì†Œì…œ ë§í¬
            let socialHtml = '<div class="social-links">';
            if (data.social_links) { // APIì—ì„œ ì£¼ì§€ ì•ŠëŠ”ë‹¤ë©´ ë¹ˆ ê°’
                // í•„ìš”í•˜ë‹¤ë©´ API ìˆ˜ì •í•´ì„œ social_linksë„ basicì— í¬í•¨í•´ì•¼ í•¨. í˜„ì¬ëŠ” ì—†ìŒ.
            }
            // ì„ì‹œ: ì†Œì…œ ë§í¬ëŠ” API ì‘ë‹µì— ì—†ìœ¼ë¯€ë¡œ ê¸°ì¡´ ë¡œì§ ìœ ì§€ ë¶ˆê°€í•˜ë‚˜, 
            // ìš”êµ¬ì‚¬í•­ì— ì–¸ê¸‰ ì—†ìœ¼ë¯€ë¡œ íŒ¨ìŠ¤í•˜ê±°ë‚˜ dataì— ìˆìœ¼ë©´ í‘œì‹œ.
            // (ê¸°ì¡´ ì½”ë“œì—ì„œë„ social_linksëŠ” API ì‘ë‹µì— ì—†ì—ˆìŒ, ì•„ë§ˆ í•˜ë“œì½”ë”©ì´ë‚˜ ì¶”í›„ í™•ì¥ì„ ì—¼ë‘ì— ë‘” ì½”ë“œì˜€ì„ ë“¯)
            // ì—¬ê¸°ì„  ì¼ë‹¨ ë‹«ì•„ë‘ .
            socialHtml += '</div>';

            const noviceHtml = isNovice ? `<span class="novice-badge">ğŸŒ± í¬ë§ìƒ</span>` : '';

            const badgeAttr = isLive
                ? `onclick="event.stopPropagation(); window.open('https://play.sooplive.co.kr/${id}', '_blank')"`
                : '';
            const badgeStyle = isLive ? 'cursor:pointer;' : '';

            const postId = data.postId || '0';
            const postLink = `https://cafe.naver.com/bver99/${postId}`;

            card.innerHTML = `
            <img src="${img}" alt="${id}" onerror="this.src='${DEFAULT_IMG}'">
            <div class="info">
                <div class="info-header">
                    <h3>${name}</h3> 
                    <div>${noviceHtml}<span class="status-badge ${isLive ? 'live' : ''}" style="${badgeStyle}" ${badgeAttr}>${isLive ? 'LIVE' : 'OFF'}</span></div>
                </div>
                <div class="info-id">@${id}</div>
                <div class="info-fan">ì• ì²­ììˆ˜: ${fanCnt.toLocaleString()}</div>
                <a href="${postLink}" target="_blank" class="post-link" onclick="event.stopPropagation()">
                    <img src="https://cafe.naver.com/favicon.ico"> ê²Œì‹œê¸€ ë³´ê¸°
                </a>
            </div>
        `;

            card.onclick = () => openModal(id);
        }

        async function openModal(id) {
            currentStreamerId = id;
            currentYear = 2026;
            currentMonth = 1;

            // 0. ì´ˆê¸°í™”: ëª¨ë‹¬ ë‚´ìš©ì„ ë¹„ìš°ê±°ë‚˜ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            resetModalContent();

            // 1. ëª¨ë‹¬ í‘œì‹œ
            MODAL.style.display = "block";

            let data = STREAMER_DATA[id];
            const now = Date.now();

            // 1. ë°ì´í„°ê°€ ì—†ê±°ë‚˜
            // 2. VOD ëª©ë¡(ìƒì„¸ì •ë³´)ì´ ì—†ê±°ë‚˜ (basicë§Œ ë¡œë“œëœ ê²½ìš°)
            // 3. ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ë¡œë¶€í„° 5ë¶„ì´ ì§€ë‚¬ìœ¼ë©´ -> Full Request
            const needUpdate = !data || !data.vods || (now - (data.lastUpdated || 0) > CACHE_DURATION);

            if (needUpdate) {
                // ë¡œë”© UI í‘œì‹œ (ì˜¤ë²„ë ˆì´ í™œì„±í™”)
                LOADING_OVERLAY.classList.add('active');

                // Full ë°ì´í„° ìš”ì²­
                await fetchStreamerData(id, 'full');
                data = STREAMER_DATA[id]; // ê°±ì‹ ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

                // ë¡œë”© ì¢…ë£Œ
                LOADING_OVERLAY.classList.remove('active');
            }

            updateModalHeader(data, currentYear, currentMonth);
            renderCalendar();
        }

        // ëª¨ë‹¬ ì´ˆê¸°í™”: ë¹ˆ ìº˜ë¦°ë”, ë¹ˆ ê·¸ë˜í”„, ê¸°ë³¸ í—¤ë” ë“±
        function resetModalContent() {
            // í—¤ë” ì´ˆê¸°í™”
            const data = STREAMER_DATA[currentStreamerId] || { nickname: currentStreamerId, fan_cnt: 0 };
            const img = data.profile_img || DEFAULT_IMG;

            // HeaderëŠ” ê¸°ë³¸ ì •ë³´(ì´ë¯¸ì§€, ë‹‰ë„¤ì„)ê°€ ìˆë‹¤ë©´ ê·¸ê±¸ë¡œ ì„¸íŒ…, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            // ì—¬ê¸°ì„  fan_cnt ë“±ì„ ë³´ì—¬ì£¼ê¸°ë³´ë‹¨ ë¡œë”©ì¤‘ ëŠë‚Œì„ ìœ„í•´ ìµœì†Œí™”
            document.getElementById('modalHeader').innerHTML = `
            <img src="${img}">
            <div>
                <h2>${data.nickname}</h2>
                <p style="color:var(--text-sub); margin:5px 0 0 0;">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        `;

            // ìº˜ë¦°ë” ì´ˆê¸°í™” (ë¹ˆ ê·¸ë¦¬ë“œ)
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const days = ['ì£¼ê°„', 'ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);
            // ëŒ€ëµì ì¸ ë¹ˆ ì¹¸ (ë¡œë”© ì¤‘ ëª¨ì–‘ ìœ ì§€)
            for (let i = 0; i < 35; i++) grid.innerHTML += `<div class="cal-day empty" style="border:1px dashed #334155; opacity:0.3;"></div>`;

            // ê·¸ë˜í”„ ì´ˆê¸°í™”
            if (timeChartInstance) {
                timeChartInstance.destroy();
                timeChartInstance = null;
            }
            // ë¹ˆ ê·¸ë˜í”„ ìƒì„± (ì¶•ë§Œ ë³´ì´ê²Œ)
            const ctx1 = document.getElementById('timeChart').getContext('2d');
            timeChartInstance = new Chart(ctx1, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateModalHeader(data, year, month) {
            const header = document.getElementById('modalHeader');
            const img = data.profile_img || DEFAULT_IMG;

            let totalDurationSec = 0;
            let count = 0;
            const monthPrefix = `${year}-${String(month).padStart(2, '0')}`;

            if (data.vods) {
                data.vods.forEach(v => {
                    if (v.date.startsWith(monthPrefix)) {
                        totalDurationSec += v.duration_sec || 0;
                        count++;
                    }
                });
            }

            let avgTimeStr = "0ë¶„";
            if (count > 0) {
                const avgSec = totalDurationSec / count;
                const h = Math.floor(avgSec / 3600);
                const m = Math.floor((avgSec % 3600) / 60);
                avgTimeStr = h > 0 ? `${h}ì‹œê°„ ${m}ë¶„` : `${m}ë¶„`;
            }

            // Format station open date (YYYY-MM-DD HH:mm:ss -> YYYY.MM.DD)
            let openDateStr = "";
            if (data.station_open_date) {
                const datePart = data.station_open_date.split(' ')[0];
                openDateStr = datePart.replace(/-/g, '.');
            }

            header.innerHTML = `
            <img src="${img}">
            <div>
                <h2>${data.nickname} 
                    <a href="https://www.sooplive.co.kr/station/${data.id}" target="_blank" class="soop-link">
                        <img src="${SOOP_ICON}" class="soop-icon" onerror="this.style.display='none'"> ë°©ì†¡êµ­
                    </a>
                </h2>
                <p style="color:var(--text-sub); margin:5px 0 0 0; line-height: 1.6;">
                    <span title="ë°©ì†¡êµ­ ê°œì„¤ì¼">ë°©ì†¡êµ­ ê°œì„¤ì¼: ${openDateStr}</span>
                    <br>
                    ì• ì²­ì ${data.fan_cnt.toLocaleString()}ëª… <span style="margin:0 5px">/</span>
                    ${month}ì›” í‰ê·  ë°©ì†¡ì‹œê°„ <b style="color:#fff">${avgTimeStr}</b>
                </p>
            </div>
        `;
        }

        function changeMonth(delta) {
            let newDate = new Date(currentYear, currentMonth - 1 + delta, 1);
            let newYear = newDate.getFullYear();
            let newMonth = newDate.getMonth() + 1;

            if (newYear < 2025 || (newYear === 2025 && newMonth < 9)) return;
            if (newYear > 2026 || (newYear === 2026 && newMonth > 2)) return;

            currentYear = newYear;
            currentMonth = newMonth;

            if (currentStreamerId && STREAMER_DATA[currentStreamerId]) {
                updateModalHeader(STREAMER_DATA[currentStreamerId], currentYear, currentMonth);
            }

            renderCalendar();
        }

        function renderCalendar() {
            const title = document.getElementById('calTitle');
            const grid = document.getElementById('calendarGrid');
            const chartTitle = document.getElementById('chartTitle');

            title.innerText = `${currentYear}. ${currentMonth}`;
            chartTitle.innerText = `${currentYear}ë…„ ${currentMonth}ì›” ë°©ì†¡ ì‹œê°„`;

            grid.innerHTML = '';

            const days = ['ì£¼ê°„', 'ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);

            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            const now = new Date();
            const todayY = now.getFullYear();
            const todayM = now.getMonth() + 1;
            const todayD = now.getDate();

            const data = STREAMER_DATA[currentStreamerId];
            const vodMap = {};

            let openY = 0, openM = 0, openD = 0;
            if (data && data.station_open_date) {
                const dateParts = data.station_open_date.split(' ')[0].split('-');
                if (dateParts.length === 3) {
                    openY = parseInt(dateParts[0]);
                    openM = parseInt(dateParts[1]);
                    openD = parseInt(dateParts[2]);
                }
            }

            if (data && data.vods) {
                data.vods.forEach(v => {
                    if (!vodMap[v.date]) vodMap[v.date] = [];
                    vodMap[v.date].push(v);
                });
            }

            let currentWeekStats = { dayCount: 0, totalSec: 0 }; // count -> dayCount

            for (let i = 0; i < startDay; i++) {
                if (i === 0) grid.innerHTML += `<div class="cal-week-stat"></div>`;
                grid.innerHTML += `<div class="cal-day empty"></div>`;
            }

            for (let d = 1; d <= totalDays; d++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const simpleDateStr = `${currentYear}${String(currentMonth).padStart(2, '0')}${String(d).padStart(2, '0')}`;
                const vods = vodMap[dateStr];

                if ((startDay + d - 1) % 7 === 0) {
                    grid.innerHTML += `<div class="cal-week-stat"></div>`;
                    currentWeekStats = { dayCount: 0, totalSec: 0 };
                }

                let content = `<div class="day-num">${d}</div>`;
                let className = "cal-day";
                if (currentYear === todayY && currentMonth === todayM && d === todayD) {
                    className += " is-today";
                }
                if (currentYear === openY && currentMonth === openM && d === openD) {
                    className += " station-open-day";
                }

                // ì…€ í´ë¦­ ì‹œ ë§í¬ ì„¤ì • (ê¸°ë³¸ì€ ê²Œì‹œíŒ ê²€ìƒ‰, VODê°€ ìˆìœ¼ë©´ ë‹¤ì‹œë³´ê¸° ê²€ìƒ‰)
                let targetUrl = `https://www.sooplive.co.kr/station/${currentStreamerId}/board?period=directInput&startDate=${simpleDateStr}&endDate=${simpleDateStr}`;

                if (vods && vods.length > 0) {
                    className += " has-vod";
                    if (vods.length > 1) className += " multi-vod";

                    // ë‹¤ì‹œë³´ê¸°(Review) ê²€ìƒ‰ ë§í¬ë¡œ êµì²´
                    targetUrl = `https://www.sooplive.co.kr/station/${currentStreamerId}/vod/review?period=directInput&startDate=${simpleDateStr}&endDate=${simpleDateStr}&sort=reg_date_asc`;

                    let totalSec = 0;
                    let timeHtml = "";

                    vods.forEach((v, index) => {
                        totalSec += (v.duration_sec || 0);
                        const parts = v.duration.split(':').map(Number);
                        let tStr = "";
                        if (parts.length === 3 && parts[0] > 0) tStr = `${parts[0]}ì‹œê°„`;
                        else if (parts.length === 2) tStr = `${parts[0]}ë¶„`;
                        else tStr = v.duration;
                        timeHtml += `<div>${tStr}</div>`;
                    });

                    currentWeekStats.dayCount += 1; // VOD ê°œìˆ˜ê°€ ì•„ë‹ˆë¼ ë°©ì†¡í•œ 'ë‚ ì§œ' ìˆ˜ ì¹´ìš´íŠ¸
                    currentWeekStats.totalSec += totalSec;
                    updateWeekStat(currentWeekStats);

                    content += `<div class="day-time">${timeHtml}</div>`;
                }

                grid.innerHTML += `<div class="${className}" onclick="window.open('${targetUrl}', '_blank')">${content}</div>`;
            }

            renderCharts(data.vods);
        }

        function updateWeekStat(stats) {
            const statsDivs = document.getElementsByClassName('cal-week-stat');
            if (statsDivs.length > 0) {
                const lastStat = statsDivs[statsDivs.length - 1];
                // í‰ê·  ì‹œê°„ì€ ì´ ì‹œê°„ì„ ë°©ì†¡ ì¼ìˆ˜ë¡œ ë‚˜ëˆ”
                const avg = stats.dayCount > 0 ? (stats.totalSec / 3600 / stats.dayCount).toFixed(1) : 0.0;
                lastStat.innerHTML = `<span>${stats.dayCount}íšŒ</span><span style="color:#6ee7b7">í‰ê·  ${avg}h</span>`;
            }
        }

        function renderCharts(vods) {
            const labels = [];
            const durationData = [];
            const lastDayObj = new Date(currentYear, currentMonth, 0);
            const totalDays = lastDayObj.getDate();

            for (let d = 1; d <= totalDays; d++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                labels.push(String(d));
                let dayDuration = 0;
                if (vods) {
                    vods.forEach(v => {
                        if (v.date === dateStr) dayDuration += (v.duration_sec || 0) / 3600;
                    });
                }
                durationData.push(dayDuration);
            }

            if (timeChartInstance) timeChartInstance.destroy();

            const ctx1 = document.getElementById('timeChart').getContext('2d');
            timeChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë°©ì†¡ ì‹œê°„',
                        data: durationData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.4,  /* 0.1ì—ì„œ 0.4ë¡œ ë³€ê²½í•˜ì—¬ ê³¡ì„ í˜•ìœ¼ë¡œ ë§Œë“¦ */
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    return context[0].label + 'ì¼';
                                },
                                label: function (context) {
                                    return context.parsed.y.toFixed(1) + 'ì‹œê°„';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            title: { display: true, text: 'ì‹œê°„' }
                        },
                        x: {
                            grid: { display: false },
                            title: { display: true, text: 'ì¼' }
                        }
                    }
                }
            });
        }

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';

        // ì„¤ì • íŒŒì¼ ì—†ì´ ì¦‰ì‹œ ì‹œì‘
        startApp();
    </script>
</body>

</html>